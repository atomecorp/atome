#!/usr/bin/env ruby
# frozen_string_literal: true

require 'fileutils'

# below are the methods needed for atome creation and run

def delete_all(dir)
  Dir.foreach(dir) do |e|
    next if %w[. ..].include? e
    full_name = dir + File::Separator + e
    if FileTest.directory?(full_name)
      delete_all(full_name)
    else
      File.delete(full_name)
    end
  end
  Dir.delete(dir)
end

def run(platform, location, port=9292)
  case platform
  when :server
    require 'atome'
    Thread.new do
      sleep 1.5
      system("open", "http://127.0.0.1:#{port}")
    end
    `cd .#{location}/server;rackup --server puma --port #{port}  --env production`
  when :browser
    `cd .#{location}/build;open index.html`
  when :osx
    # require 'webview_ruby'
    # webview = WebviewRuby::Webview.new
    # webview.set_title('atome')
    # webview.set_size(480, 360)
    # webview.navigate("file:/#{`pwd`}#{location}/build/index.html")
    # webview.run
  else
    `cd .#{location}/build;open index.html`
  end

end

def build_app(production)
  current_path = `pwd`.chomp
  # now run the rake task to build the needed libraries (atome, renderers, etc...)
  app_builder_helpers = File.join(File.dirname(__FILE__), '../app_builder_helpers')
  `cd #{app_builder_helpers};rake build_user_code[#{current_path},#{production}]`
end

# below we analyse the ARGV
location = '/'
force = nil
production = nil
port=9292

if ARGV.include?('production')
  production = 'production'
end

if ARGV.include?('force')
  force = 'force'
end

if ARGV.include?('port:')
    port= ARGV[ARGV.find_index('port:')+1]
  end

platforms = %w[android browser server osx freebsd ios linux osx windows]
# now setting build_target

build_target = 'browser'

platforms.each do |platform|
  if ARGV.include?(platform)
    build_target = platform
  end

end

if ARGV.include?('create')
  project_name = ARGV[1]
  delete_all(project_name) if force == 'force' && File.directory?(project_name)
  Dir.mkdir project_name.to_s
  current_path = `pwd`.chomp
  gem_assets_location = File.join(File.dirname(__FILE__), '../vendor/assets/')
  app_builder_helpers = File.join(File.dirname(__FILE__), '../app_builder_helpers')
  target_template_location = "#{current_path}/#{project_name}"
  Dir.entries(gem_assets_location).select do |entry|
    if File.join(entry) && !%w[. ..].include?(entry)
      entry = "#{File.dirname(__FILE__)}/../vendor/assets/#{entry}"
      FileUtils.cp_r entry, target_template_location
    end
  end
  # now run the rake task to build the needed libraries (atome, renderers, etc...)
  `cd #{app_builder_helpers};rake system_builder[#{current_path}/#{project_name},#{production}]`
  location = "/#{project_name}"
end

if ARGV.include?('build')
  build_app(production)
end

if ARGV.include?('run')
  case build_target
  when 'android'
  when 'browser'
    run(:browser, location)
  when 'freebsd'
  when 'ios'
  when 'linux'
  when 'osx'
    run(:osx, location)
  when 'server'
    file = File.open("#{`pwd`.chomp}#{location}/server/config.ru")
    text = file.read
    text = text.gsub("run Unreloader", "")
    text = text.gsub("run App.freeze.app", "")
    if production == 'production'
      text = text + "\nrun App.freeze.app"
    else
      text = text + "\nrun Unreloader"
    end
    File.open("#{`pwd`.chomp}#{location}/server/config.ru", 'w') do |f|
      f.puts text
    end
    run(:server, location,port)
  when 'windows'
  else
    run(:browser, location)
  end
end


